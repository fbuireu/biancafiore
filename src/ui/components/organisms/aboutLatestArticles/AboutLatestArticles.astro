---
import MarkdownIt from "markdown-it";
import { generateExcerpt } from "../../../shared/utils/generateExcerpt";
import { DEFAULT_DATE_FORMAT } from "../../../../consts";
import { getCollection, getEntry } from "astro:content";
import "./about-latest-articles.css";
import { AboutLatestArticlesSlider } from "@components/molecules/aboutLatestArticlesSlider";

const parser: MarkdownIt = MarkdownIt("default", {});
const images = import.meta.glob("/src/assets/**/*.{jpeg,jpg,png,gif}");
let articles = await getCollection("articles");
articles.sort((a, b) => new Date(b.data.publishDate).valueOf() - new Date(a.data.publishDate).valueOf()).splice(4);

articles = await Promise.all(
	articles.map(async (article) => {
		const author = await getEntry(article.data.author.collection, article.data.author.slug);
		const description = article.data.description ?? generateExcerpt({ parser, content: article.body }).excerpt;
		const publishDate = new Date(article.data.publishDate).toLocaleDateString("en", DEFAULT_DATE_FORMAT);

		return {
			...article,
			data: {
				...article.data,
				author,
				description,
				publishDate,
			},
		};
	}),
);
---

<section class="about-latest-articles__wrapper common-wrapper">
  <h3 class="about-latest-articles__title section-title">
    Fresh from <a class="clickable" href="/articles">the blog</a>
  </h3>
  <div class="about-latest-articles__inner">
    <div class="about-latest-articles__quote__wrapper">
      <h4 class="about-latest-articles__quote">Lorem ipsum dolir sit Amet. Dolor sit amet.</h4>
      <h6 class="about-latest-articles__quote__author">Ferran Buireu</h6>
    </div>
    <AboutLatestArticlesSlider client:load articles={articles} />
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "ItemList",
      "itemListElement": articles.map((article, index) => ({
        "@type": "ListItem",
        "position": index + 1,
        "url": new URL(article.slug, Astro.url).href
      }))
    })}/>
  </div>
</section>
